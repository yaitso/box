#cloud-config

users:
    - name: ${username}
      groups: sudo
      shell: /bin/bash
      sudo: ["ALL=(ALL) NOPASSWD:ALL"]
      ssh_authorized_keys:
          - ${ssh_key}

package_update: true
package_upgrade: true

packages:
    - ufw
    - fail2ban
    - unattended-upgrades

write_files:
    - path: /etc/ssh/sshd_config.d/99-hardening.conf
      content: |
          PermitRootLogin no
          PasswordAuthentication no
          ChallengeResponseAuthentication no
          PubkeyAuthentication yes
          X11Forwarding no
          MaxAuthTries 3
      permissions: "0644"

runcmd:
    - systemctl enable ssh
    - systemctl reload ssh
    - ufw default deny incoming
    - ufw default allow outgoing
    - ufw allow 22/tcp
    - ufw allow 80/tcp
    - ufw allow 443/tcp
    - ufw --force enable
    - systemctl enable fail2ban
    - systemctl start fail2ban
    - mkdir -p /mnt/data
    - |
        for i in {1..30}; do
          VOLUME_DEVICE=$(lsblk -no NAME,SERIAL | grep -i "volume-" | awk '{print "/dev/"$1}' | head -1)
          if [ -n "$VOLUME_DEVICE" ]; then
            mkfs.ext4 -F $VOLUME_DEVICE || true
            mount $VOLUME_DEVICE /mnt/data
            echo "$VOLUME_DEVICE /mnt/data ext4 defaults,nofail 0 2" >> /etc/fstab
            mkdir -p /mnt/data/postgres /mnt/data/materialize
            chown -R ${username}:${username} /mnt/data
            break
          fi
          sleep 2
        done
    - echo "${env_file_b64}" | base64 -d > /tmp/.env
    - sed 's/BOX_USERNAME=.*/BOX_USERNAME=${username}/' /tmp/.env > /home/${username}/.env.temp
    - sudo -u ${username} bash -c 'cd /home/${username} && git clone https://'$(grep '^GH_TOKEN=' /tmp/.env | cut -d= -f2)'@github.com/yaitso/box.git'
    - mv /home/${username}/.env.temp /home/${username}/box/.env
    - chown ${username}:${username} /home/${username}/box/.env
    - chmod 600 /home/${username}/box/.env
    - rm /tmp/.env
    - cp /home/${username}/box/tools/bashrc /home/${username}/.bashrc
    - cp /home/${username}/box/tools/bash_profile /home/${username}/.bash_profile
    - chown ${username}:${username} /home/${username}/.bashrc /home/${username}/.bash_profile
    - |
        sudo -u ${username} bash -c '
          cd /home/${username}/box
          export NIX_INSTALLER_NO_MODIFY_PROFILE=1
          ./install.sh > /tmp/install.log 2>&1
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
            mkdir -p ~/.config/nix
            echo "experimental-features = nix-command flakes" > ~/.config/nix/nix.conf
            nix run home-manager -- switch --flake /home/${username}/box#linux >> /tmp/install.log 2>&1
          fi
        '
    - echo "setup complete" > /tmp/test.txt

final_message: "box fully configured after $UPTIME seconds"
